{% extends 'dashboard/base.html' %}
{% load humanize %}
{% load static %}

{% block page_title %}Overview{% endblock page_title %}
{% block page_subtitle %}Welcome to your dashboard.{% endblock page_subtitle %}

{% block content %}
<!-- --- Stats Cards --- -->
<div class="grid grid-cols-1 md:grid-cols-2 2xl:grid-cols-3 gap-6 mb-6">
    <div class="bg-white border rounded-xl p-6">
        <div class="flex items-center">
            <div class="inline-flex flex-shrink-0 justify-center items-center w-12 h-12 text-blue-700 bg-blue-100 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                    <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" />
                    <path fill-rule="evenodd" d="M1.323 11.447C2.811 6.976 7.028 3.75 12.001 3.75c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113-1.487 4.471-5.705 7.697-10.677 7.697-4.97 0-9.186-3.223-10.675-7.69a1.762 1.762 0 0 1 0-1.113ZM17.25 12a5.25 5.25 0 1 1-10.5 0 5.25 5.25 0 0 1 10.5 0Z" clip-rule="evenodd" />
                  </svg>
            </div>
            <div class="ml-4">
                <h2 class="text-sm font-medium text-gray-600">Total Views</h2>
                <p class="text-2xl font-semibold text-gray-900">{{ total_views_and_engagement.views|intcomma }}</p>
            </div>
        </div>
    </div>
    <div class="bg-white border rounded-xl p-6">
        <div class="flex items-center">
            <div class="inline-flex flex-shrink-0 justify-center items-center w-12 h-12 text-blue-700 bg-blue-100 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                    <path fill-rule="evenodd" d="M4.125 3C3.089 3 2.25 3.84 2.25 4.875V18a3 3 0 0 0 3 3h15a3 3 0 0 1-3-3V4.875C17.25 3.839 16.41 3 15.375 3H4.125ZM12 9.75a.75.75 0 0 0 0 1.5h1.5a.75.75 0 0 0 0-1.5H12Zm-.75-2.25a.75.75 0 0 1 .75-.75h1.5a.75.75 0 0 1 0 1.5H12a.75.75 0 0 1-.75-.75ZM6 12.75a.75.75 0 0 0 0 1.5h7.5a.75.75 0 0 0 0-1.5H6Zm-.75 3.75a.75.75 0 0 1 .75-.75h7.5a.75.75 0 0 1 0 1.5H6a.75.75 0 0 1-.75-.75ZM6 6.75a.75.75 0 0 0-.75.75v3c0 .414.336.75.75.75h3a.75.75 0 0 0 .75-.75v-3A.75.75 0 0 0 9 6.75H6Z" clip-rule="evenodd" />
                    <path d="M18.75 6.75h1.875c.621 0 1.125.504 1.125 1.125V18a1.5 1.5 0 0 1-3 0V6.75Z" />
                </svg>
            </div>
            <div class="ml-4">
                <h2 class="text-sm font-medium text-gray-600">Published Posts</h2>
                <p class="text-2xl font-semibold text-gray-900">{{ total_posts|intcomma }}</p>
            </div>
        </div>
    </div>
    <div class="bg-white border rounded-xl p-6">
        <div class="flex items-center">
            <div class="inline-flex flex-shrink-0 justify-center items-center w-12 h-12 text-blue-700 bg-blue-100 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                    <path d="M7.493 18.5c-.425 0-.82-.236-.975-.632A7.48 7.48 0 0 1 6 15.125c0-1.75.599-3.358 1.602-4.634.151-.192.373-.309.6-.397.473-.183.89-.514 1.212-.924a9.042 9.042 0 0 1 2.861-2.4c.723-.384 1.35-.956 1.653-1.715a4.498 4.498 0 0 0 .322-1.672V2.75A.75.75 0 0 1 15 2a2.25 2.25 0 0 1 2.25 2.25c0 1.152-.26 2.243-.723 3.218-.266.558.107 1.282.725 1.282h3.126c1.026 0 1.945.694 2.054 1.715.045.422.068.85.068 1.285a11.95 11.95 0 0 1-2.649 7.521c-.388.482-.987.729-1.605.729H14.23c-.483 0-.964-.078-1.423-.23l-3.114-1.04a4.501 4.501 0 0 0-1.423-.23h-.777ZM2.331 10.727a11.969 11.969 0 0 0-.831 4.398 12 12 0 0 0 .52 3.507C2.28 19.482 3.105 20 3.994 20H4.9c.445 0 .72-.498.523-.898a8.963 8.963 0 0 1-.924-3.977c0-1.708.476-3.305 1.302-4.666.245-.403-.028-.959-.5-.959H4.25c-.832 0-1.612.453-1.918 1.227Z" />
                </svg>
            </div>
            <div class="ml-4">
                <h2 class="text-sm font-medium text-gray-600">Total Likes</h2>
                <p class="text-2xl font-semibold text-gray-900">{{ total_views_and_engagement.likes|intcomma }}</p>
            </div>
        </div>
    </div>
    <div class="bg-white border rounded-xl p-6">
        <div class="flex items-center">
            <div class="inline-flex flex-shrink-0 justify-center items-center w-12 h-12 text-blue-700 bg-blue-100 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                    <path fill-rule="evenodd" d="M4.804 21.644A6.707 6.707 0 0 0 6 21.75a6.721 6.721 0 0 0 3.583-1.029c.774.182 1.584.279 2.417.279 5.322 0 9.75-3.97 9.75-9 0-5.03-4.428-9-9.75-9s-9.75 3.97-9.75 9c0 2.409 1.025 4.587 2.674 6.192.232.226.277.428.254.543a3.73 3.73 0 0 1-.814 1.686.75.75 0 0 0 .44 1.223ZM8.25 10.875a1.125 1.125 0 1 0 0 2.25 1.125 1.125 0 0 0 0-2.25ZM10.875 12a1.125 1.125 0 1 1 2.25 0 1.125 1.125 0 0 1-2.25 0Zm4.875-1.125a1.125 1.125 0 1 0 0 2.25 1.125 1.125 0 0 0 0-2.25Z" clip-rule="evenodd" />
                </svg>
            </div>
            <div class="ml-4">
                <h2 class="text-sm font-medium text-gray-600">Total Comments</h2>
                <p class="text-2xl font-semibold text-gray-900">{{ total_views_and_engagement.comments|intcomma }}</p>
            </div>
        </div>
    </div>
    <div class="bg-white border rounded-xl p-6">
        <div class="flex items-center">
            <div class="inline-flex flex-shrink-0 justify-center items-center w-12 h-12 text-yellow-500 bg-yellow-100 rounded-full">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                </svg>
            </div>
            <div class="ml-4">
                <h2 class="text-sm font-medium text-gray-600">Pending posts</h2>
                <p class="text-2xl font-semibold text-gray-900">{{ pending_posts|intcomma }}</p>
            </div>
        </div>
    </div>
</div>

<!-- --- Main Grid Section --- -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- --- Latest Posts Section --- -->
    <div class="lg:col-span-2 bg-white border rounded-xl">
        <div class="flex justify-between items-center p-6">
            <h3 class="text-xl font-semibold text-gray-900">Latest Posts</h3>
            <a href="{% url 'dashboard:posts' %}" class="text-sm font-medium text-blue-600 hover:underline">View all</a>
        </div>
        
        <div class="relative overflow-x-auto">
            {% if latest_posts %}
                <table class="w-full text-sm text-left rtl:text-right text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                        <tr>
                            <th scope="col" class="px-6 py-6 w-[45%]">Title</th>
                            <th scope="col" class="px-6 py-6">Status</th>
                            <th scope="col" class="px-6 py-6">Stats</th>
                            <th scope="col" class="px-6 py-6">Date</th>
                            <th scope="col" class="px-6 py-6">
                                <span class="sr-only">Actions</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for post in latest_posts %}
                            <tr class="bg-white border-b hover:bg-gray-50 {% if forloop.last %}border-b-0{% endif %}">
                                <th scope="row" class="px-6 py-6">
                                    <div class="min-w-64 flex items-center space-x-3">
                                        {% if post.image %}
                                            <img src="{{ post.image.url }}" class="w-10 h-10 rounded-lg object-cover" alt="{{ post.title }}">
                                        {% else %}
                                            <img src="{% static 'images/post_image.jpg' %}" class="w-10 h-10 rounded-lg flex-shrink-0 object-cover" alt="Placeholder Image">
                                        {% endif %}
                                        <div class="flex flex-col">
                                            <a href="{% url 'blog:post_detail' post.author.username post.slug %}" class="font-medium text-gray-900 hover:underline line-clamp-2">{{ post.title }}</a>
                                        </div>
                                    </div>
                                </th>
                                <td class="px-6 py-6">
                                    {% if post.is_published %}
                                        <span class="text-xs rounded-full bg-green-100 text-green-800 px-2.5 py-0.5">Published</span>
                                    {% else %}
                                        <span class="text-xs rounded-full bg-yellow-100 text-yellow-800 px-2.5 py-0.5">Draft</span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-6">
                                    <div class="flex items-center space-x-3 text-sm">
                                        <div class="flex items-center text-gray-500" title="Views">
                                            <svg class="w-[1.125rem] h-[1.125rem] mr-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                                                <path fill-rule="evenodd" d="M15.03 9.684h3.965c.322 0 .64.08.925.232.286.153.532.374.717.645a2.109 2.109 0 0 1 .242 1.883l-2.36 7.201c-.288.814-.48 1.355-1.884 1.355-2.072 0-4.276-.677-6.157-1.256-.472-.145-.924-.284-1.348-.404h-.115V9.478a25.485 25.485 0 0 0 4.238-5.514 1.8 1.8 0 0 1 .901-.83 1.74 1.74 0 0 1 1.21-.048c.396.13.736.397.96.757.225.36.32.788.269 1.211l-1.562 4.63ZM4.177 10H7v8a2 2 0 1 1-4 0v-6.823C3 10.527 3.527 10 4.176 10Z" clip-rule="evenodd"/>
                                            </svg>
                                            {{ post.likes_count|default:"0" }}
                                        </div>
                                        <div class="flex items-center text-gray-500" title="Comments">
                                            <svg class="w-[1.125rem] h-[1.125rem] mr-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                                                <path fill-rule="evenodd" d="M3 5.983C3 4.888 3.895 4 5 4h14c1.105 0 2 .888 2 1.983v8.923a1.992 1.992 0 0 1-2 1.983h-6.6l-2.867 2.7c-.955.899-2.533.228-2.533-1.08v-1.62H5c-1.105 0-2-.888-2-1.983V5.983Zm5.706 3.809a1 1 0 1 0-1.412 1.417 1 1 0 1 0 1.412-1.417Zm2.585.002a1 1 0 1 1 .003 1.414 1 1 0 0 1-.003-1.414Zm5.415-.002a1 1 0 1 0-1.412 1.417 1 1 0 1 0 1.412-1.417Z" clip-rule="evenodd"/>
                                            </svg>
                                            {{ post.comments_count|default:"0" }}
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-6 whitespace-nowrap">
                                    {{ post.created_at|date:"M d, Y" }}
                                </td>
                                <td class="px-6 py-6">
                                    <button id="post-{{ post.id }}-dropdown-button" data-dropdown-toggle="post-{{ post.id }}-dropdown" class="inline-flex items-center text-sm font-medium hover:bg-gray-100 text-gray-500 hover:text-gray-900 rounded-lg p-2">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M6 10a2 2 0 11-4 0 2 2 0 014 0zM12 10a2 2 0 11-4 0 2 2 0 014 0zM16 12a2 2 0 100-4 2 2 0 000 4z"/>
                                        </svg>
                                    </button>
                                    <div id="post-{{ post.id }}-dropdown" class="z-10 hidden bg-white divide-y divide-gray-100 rounded-lg shadow w-44">
                                        <ul class="py-2 text-sm text-gray-700">
                                            <li>
                                                <a href="#" class="block px-4 py-2 hover:bg-gray-100">Edit</a>
                                            </li>
                                            <li>
                                                <button type="button" data-modal-target="popup-modal-{{ post.id }}" data-modal-toggle="popup-modal-{{ post.id }}" class="block w-full text-start hover:text-red-500 px-4 py-2 hover:bg-gray-100">Delete</button>
                                            </li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                            <div id="popup-modal-{{ post.id }}" tabindex="-1" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
                                <div class="relative p-4 w-full max-w-md max-h-full">
                                    <div class="relative bg-white rounded-lg shadow">
                                        <button type="button" class="absolute top-3 end-2.5 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center" data-modal-hide="popup-modal-{{ post.id }}">
                                            <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                                            </svg>
                                            <span class="sr-only">Close modal</span>
                                        </button>
                                        <div class="p-4 md:p-5 text-center">
                                            <svg class="mx-auto mb-4 text-gray-400 w-12 h-12" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 11V6m0 8h.01M19 10a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
                                            </svg>
                                            <h3 class="mb-5 text-lg font-normal text-gray-500">Are you sure you want to delete this post?</h3>
                                            <a href="{% url 'blog:delete_post' post.id %}" class="text-white bg-red-600 hover:bg-red-800 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center">
                                                Yes, I'm sure
                                            </a>
                                            <button data-modal-hide="popup-modal-{{ post.id }}" type="button" class="py-2.5 px-5 ms-3 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4 focus:ring-gray-100">No, cancel</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p class="py-24 text-center text-sm text-gray-500">No latest posts found.</p>
            {% endif %}

        </div>
    </div>

    <!-- --- Top Performing Posts Card --- -->
    <div class="col-span-full bg-white rounded-xl border p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Top Performing Posts</h3>
            <span class="text-sm text-gray-500">Based on engagement</span>
        </div>
        
        <div class="space-y-4">
            {% for post in top_performing_posts %}
                <div class="flex items-center gap-6 p-4 border rounded-lg hover:bg-gray-50 transition-colors">
                    <!-- Post Number -->
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-semibold">
                        {{ forloop.counter }}
                    </div>
                    
                    <!-- Post Info -->
                    <div class="flex-grow min-w-0">
                        <h4 class="font-medium text-gray-900 truncate">
                            <a href="{% url 'blog:post_detail' post.author.username post.slug %}" class="hover:text-blue-600">
                                {{ post.title }}
                            </a>
                        </h4>
                        <div class="flex items-center gap-6 mt-1">
                            <!-- Views -->
                            <div class="flex items-center text-sm text-gray-500">
                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                                    <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                                </svg>
                                {{ post.views_count }}
                            </div>
                            
                            <!-- Likes -->
                            <div class="flex items-center text-sm text-gray-500">
                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a4 4 0 00-.8 2.4z"/>
                                </svg>
                                {{ post.likes_count }}
                            </div>

                            <!-- Comments -->
                            <div class="flex items-center text-sm text-gray-500">
                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
                                </svg>
                                {{ post.comments_count }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Engagement Score -->
                    <div class="flex-shrink-0">
                        <div class="px-3 py-1 text-sm font-medium text-blue-600 bg-blue-100 rounded-full">
                            Score: {{ post.engagement_score }}
                        </div>
                    </div>
                </div>
            {% empty %}
                <p class="py-24 text-center text-sm text-gray-500">No top performing posts found.</p>
            {% endfor %}
        </div>
    </div>

    <!-- --- Draft Posts --- -->
    <div class="bg-white lg:col-span-2 border rounded-xl p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Draft Posts</h3>
            <a href="{% url 'dashboard:posts' %}?publish=False" class="text-blue-600 hover:underline">View all drafts</a>
        </div>
        <div class="space-y-4">
            {% for draft in draft_posts %}
                <div class="flex items-center justify-between p-3 border rounded-lg">
                    <div>
                        <a href="{% url 'blog:post_detail' draft.author.username draft.slug %}" class="hover:underline font-medium">{{ draft.title }}</a>
                        <p class="text-sm text-gray-500">Last edited {{ draft.updated_at|timesince }} ago</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button type="button" class="text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 font-medium rounded-full text-sm px-5 py-2 text-center ">
                            Edit
                        </button>
                        <button type="button" data-modal-target="popup-modal-{{ draft.id }}" data-modal-toggle="popup-modal-{{ draft.id }}" class="text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-300 font-medium rounded-full text-sm px-5 py-2 text-center ">
                            Delete
                        </button>
                    </div>
                </div>
                <!-- --- Delete Post Modal --- -->
                <div id="popup-modal-{{ draft.id }}" tabindex="-1" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
                    <div class="relative p-4 w-full max-w-md max-h-full">
                        <div class="relative bg-white rounded-lg shadow">
                            <button type="button" class="absolute top-3 end-2.5 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center" data-modal-hide="popup-modal-{{ draft.id }}">
                                <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                                </svg>
                                <span class="sr-only">Close modal</span>
                            </button>
                            <div class="p-4 md:p-5 text-center">
                                <svg class="mx-auto mb-4 text-gray-400 w-12 h-12" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 11V6m0 8h.01M19 10a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
                                </svg>
                                <h3 class="mb-5 text-lg font-normal text-gray-500">Are you sure you want to delete this post?</h3>
                                <a href="{% url 'blog:delete_post' draft.id %}" class="text-white bg-red-600 hover:bg-red-800 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center">
                                    Yes, I'm sure
                                </a>
                                <button data-modal-hide="popup-modal-{{ draft.id }}" type="button" class="py-2.5 px-5 ms-3 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4 focus:ring-gray-100">No, cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            {% empty %}
                <p class="py-24 text-center text-sm text-gray-500">No draft posts found.</p>
            {% endfor %}
        </div>
    </div>
</div>

{% endblock %}
